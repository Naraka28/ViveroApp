@model IEnumerable<ViveroApp.DTOs.MiJardinDto>
@{
    ViewData["Title"] = "Mi Jardín";
}

<section class="my-[3rem]">
    <div class="flex justify-between items-center mb-6">
        <div>
            <h2 class="text-4xl font-bold text-gray-800">Mi Jardín</h2>
            <p class="text-xl text-gray-600 mt-2">Organiza y cuida tu colección de plantas</p>
        </div>
        <a asp-controller="Plantas" asp-action="Index"
           class="bg-[#1E6241] hover:bg-[#195136] text-white px-6 py-3 rounded-xl text-lg inline-flex items-center gap-2 transition-colors">
            <i class="ph ph-plus-circle"></i>
            <span>Agregar Planta</span>
        </a>
    </div>

    @if (TempData["Mensaje"] != null)
    {
        <div class="bg-green-50 border-l-4 border-green-500 text-green-800 px-6 py-4 rounded-r-xl mb-4 flex justify-between items-center">
            <span>@TempData["Mensaje"]</span>
            <button onclick="this.parentElement.remove()" class="text-green-600 hover:text-green-800">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="bg-red-50 border-l-4 border-red-500 text-red-800 px-6 py-4 rounded-r-xl mb-4 flex justify-between items-center">
            <span>@TempData["Error"]</span>
            <button onclick="this.parentElement.remove()" class="text-red-600 hover:text-red-800">
                <i class="ph ph-x text-xl"></i>
            </button>
        </div>
    }
</section>

@if (!Model.Any())
{
    <section class="bg-[#E9F0EC] rounded-3xl py-20 px-8 my-[4rem]">
        <div class="max-w-2xl mx-auto text-center">
            <div class="inline-flex items-center justify-center w-24 h-24 bg-[#BCD0C6] rounded-full text-[#1E6241] mb-6">
                <i class="ph ph-flower text-5xl"></i>
            </div>
            <h3 class="text-3xl font-bold text-gray-800 mb-4">Tu jardín está vacío</h3>
            <p class="text-xl text-gray-600 mb-8">Comienza agregando tus primeras plantas desde el catálogo</p>
            <a asp-controller="Plantas" asp-action="Index"
               class="bg-[#1E6241] hover:bg-[#195136] text-white px-8 py-4 rounded-xl text-lg inline-block transition-colors">
                Explorar Plantas
            </a>
        </div>
    </section>
}
else
{
    <section class="my-[3rem]">
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="listado-plantas">
            @foreach (var planta in Model)
            {
                <div class="sortable-item cursor-move" data-id="@planta.MiJardinId">
                    <div class="bg-white rounded-2xl shadow-sm border border-gray-100 overflow-hidden h-full flex flex-col hover:shadow-md transition-shadow">

                        @if (!string.IsNullOrEmpty(planta.PlantaImagenUrl))
                        {
                            <div class="relative h-48 bg-cover bg-center" style="background-image: url('@planta.PlantaImagenUrl');">
                                <div class="absolute inset-0 bg-gradient-to-t from-black/30 to-transparent"></div>
                                @if (planta.NecesitaRiego)
                                {
                                    <div class="absolute top-3 right-3 bg-red-500 text-white px-3 py-1 rounded-full text-sm font-semibold flex items-center gap-1">
                                        <i class="ph ph-drop"></i>
                                        <span>¡Necesita riego!</span>
                                    </div>
                                }
                            </div>
                        }
                        else
                        {
                            <div class="h-48 bg-gray-100 flex items-center justify-center">
                                <i class="ph ph-flower text-6xl text-gray-300"></i>
                            </div>
                        }

                        <div class="p-6 flex-1 flex flex-col">
                            <h5 class="text-xl font-bold text-gray-800 mb-2">
                                @if (!string.IsNullOrEmpty(planta.Apodo))
                                {
                                    <span>@planta.Apodo</span>
                                    <span class="block text-sm font-normal text-gray-500">@planta.PlantaNombre</span>
                                }
                                else
                                {
                                    @planta.PlantaNombre
                                }
                            </h5>

                            @if (!string.IsNullOrEmpty(planta.PlantaNombreCientifico))
                            {
                                <p class="text-sm italic text-gray-500 mb-4">@planta.PlantaNombreCientifico</p>
                            }

                            <div class="space-y-2 mb-4">
                                @if (!string.IsNullOrEmpty(planta.Ubicacion))
                                {
                                    <div class="flex items-center gap-2 text-sm text-gray-600">
                                        <i class="ph ph-map-pin text-lg text-red-500"></i>
                                        <span>@planta.Ubicacion</span>
                                    </div>
                                }

                                <div class="flex items-center gap-2 text-sm text-gray-600">
                                    <i class="ph ph-calendar text-lg text-blue-500"></i>
                                    <span>Agregada el @planta.Fecha_Agregada.ToString("dd/MM/yyyy")</span>
                                </div>

                                @if (planta.UltimoRiego.HasValue)
                                {
                                    <div class="flex items-center gap-2 text-sm">
                                        <i class="ph ph-drop text-lg @(planta.NecesitaRiego ? "text-red-500" : "text-green-500")"></i>
                                        <span class="text-gray-600">Último riego: @planta.UltimoRiego.Value.ToString("dd/MM/yyyy")</span>
                                        @if (planta.DiasDesdeUltimoRiego.HasValue)
                                        {
                                            <span class="ml-auto px-2 py-0.5 text-xs rounded-full @(planta.NecesitaRiego ? "bg-red-100 text-red-700" : "bg-green-100 text-green-700")">
                                                @planta.DiasDesdeUltimoRiego días
                                            </span>
                                        }
                                    </div>
                                }
                            </div>

                            <div class="bg-gray-50 rounded-xl p-4 mb-4">
                                <div class="space-y-2 text-sm">
                                    <div class="flex items-center gap-2">
                                        <i class="ph ph-drop-half text-blue-600"></i>
                                        <span class="text-gray-700"><strong>Riego:</strong> @planta.RiegoNombre</span>
                                    </div>
                                    @if (planta.Frecuencia_Dias_Verano.HasValue && planta.Frecuencia_Dias_Invierno.HasValue)
                                    {
                                        <p class="text-xs text-gray-600 ml-6">
                                            Verano: cada @planta.Frecuencia_Dias_Verano días | Invierno: cada @planta.Frecuencia_Dias_Invierno días
                                        </p>
                                    }
                                    @if (!string.IsNullOrEmpty(planta.LuzTipo))
                                    {
                                        <div class="flex items-center gap-2">
                                            <i class="ph ph-sun text-yellow-600"></i>
                                            <span class="text-gray-700"><strong>Luz:</strong> @planta.LuzTipo</span>
                                        </div>
                                    }
                                </div>
                            </div>

                            <div class="mt-auto flex flex-wrap gap-2">
                                @if (planta.NecesitaRiego || !planta.UltimoRiego.HasValue)
                                {
                                    <form asp-action="RegistrarRiego" method="post" class="flex-1">
                                        <input type="hidden" name="id" value="@planta.MiJardinId" />
                                        <button type="submit" class="w-full px-4 py-2 bg-blue-600 hover:bg-blue-700 text-white rounded-lg text-sm font-medium transition-colors flex items-center justify-center gap-2">
                                            <i class="ph ph-drop"></i>
                                            <span>Regar</span>
                                        </button>
                                    </form>
                                }

                                <button type="button"
                                        onclick="openModal('editarModal@(planta.MiJardinId)')"
                                        class="flex-1 px-4 py-2 border border-gray-300 text-gray-700 hover:bg-gray-50 rounded-lg text-sm font-medium transition-colors">
                                    Editar
                                </button>

                                <a asp-controller="Plantas"
                                   asp-action="DetallePlanta"
                                   asp-route-id="@planta.PlantaId"
                                   class="flex-1 px-4 py-2 border border-[#1E6241] text-[#1E6241] hover:bg-[#E9F0EC] rounded-lg text-sm font-medium transition-colors text-center">
                                    Detalles
                                </a>

                                <form asp-action="Eliminar" method="post" class="flex-1"
                                      onsubmit="return confirm('¿Eliminar esta planta de tu jardín?');">
                                    <input type="hidden" name="id" value="@planta.MiJardinId" />
                                    <button type="submit" class="w-full px-4 py-2 border border-red-600 text-red-600 hover:bg-red-50 rounded-lg text-sm font-medium transition-colors">
                                        <i class="ph ph-trash"></i>
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>
    </section>

    @foreach (var planta in Model)
    {
        <div class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center p-4" id="editarModal@(planta.MiJardinId)">
            <div class="bg-white rounded-2xl max-w-md w-full">
                <form asp-action="Actualizar" method="post">
                    <div class="p-6 border-b border-gray-200">
                        <div class="flex justify-between items-center">
                            <h5 class="text-2xl font-bold text-gray-800">Editar Planta</h5>
                            <button type="button" onclick="closeModal('editarModal@(planta.MiJardinId)')" class="text-gray-400 hover:text-gray-600">
                                <i class="ph ph-x text-2xl"></i>
                            </button>
                        </div>
                        <p class="text-gray-600 mt-1">@planta.PlantaNombre</p>
                    </div>
                    <div class="p-6 space-y-4">
                        <input type="hidden" name="id" value="@planta.MiJardinId" />
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="ph ph-heart"></i> Apodo
                            </label>
                            <input type="text"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#1E6241] focus:border-transparent"
                                   name="apodo"
                                   value="@planta.Apodo"
                                   placeholder="Dale un nombre especial" />
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 mb-2">
                                <i class="ph ph-map-pin"></i> Ubicación
                            </label>
                            <input type="text"
                                   class="w-full px-4 py-3 border border-gray-300 rounded-xl focus:outline-none focus:ring-2 focus:ring-[#1E6241] focus:border-transparent"
                                   name="ubicacion"
                                   value="@planta.Ubicacion"
                                   placeholder="Ej: Sala, Balcón, Jardín" />
                        </div>
                    </div>
                    <div class="p-6 border-t border-gray-200 flex gap-3 justify-end">
                        <button type="button"
                                onclick="closeModal('editarModal@(planta.MiJardinId)')"
                                class="px-6 py-3 text-gray-700 border border-gray-300 rounded-xl hover:bg-gray-50 transition-colors font-medium">
                            Cancelar
                        </button>
                        <button type="submit"
                                class="px-6 py-3 bg-[#1E6241] hover:bg-[#195136] text-white rounded-xl transition-colors font-medium">
                            Guardar Cambios
                        </button>
                    </div>
                </form>
            </div>
        </div>
    }
}

@section Scripts {
    <script>
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }

        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        $(function () {
            if (typeof $.fn.sortable === 'undefined') {
                alert('Error: jQuery UI no está cargado.');
                return;
            }

            $("#listado-plantas").sortable({
                update: function () {
                    var ids = [];
                    $("#listado-plantas > div.sortable-item").each(function() {
                        var id = $(this).data("id");
                        if (id !== undefined && id !== null && id > 0) {
                            ids.push(parseInt(id));
                        }
                    });

                    $.ajax({
                        url: '/MiJardin/Ordenar',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(ids),
                        success: function(response) {
                            console.log('✅ Orden actualizado');
                            var mensaje = $('<div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded shadow-lg z-50">Orden guardado ✓</div>');
                            $('body').append(mensaje);
                            setTimeout(function() {
                                mensaje.fadeOut(function() {
                                    $(this).remove();
                                });
                            }, 2000);
                        },
                        error: function(xhr) {
                            console.error('❌ Error:', xhr);
                            $("#listado-plantas").sortable("cancel");
                        }
                    });
                },
                placeholder: "sortable-placeholder",
                opacity: 0.8,
                tolerance: "pointer"
            });

            $("#listado-plantas").on("mousedown", "button, a, input, form", function (e) {
                e.stopPropagation();
            });
        });
    </script>
}