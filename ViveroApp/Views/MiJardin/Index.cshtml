@model IEnumerable<ViveroApp.DTOs.MiJardinDto>
@{
    ViewData["Title"] = "Mi Jardín";
}

<div class="container mx-auto mt-4 px-4">
    <div class="flex justify-between items-center mb-4">
        <h2 class="font-semibold text-2xl">Mi Jardín</h2>
        <a asp-controller="Plantas" asp-action="Index" class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700">
            <i class="bi bi-plus-circle"></i> Agregar Planta
        </a>
    </div>

    @if (TempData["Mensaje"] != null)
    {
        <div class="bg-green-100 border border-green-400 text-green-700 px-4 py-3 rounded mb-3">@TempData["Mensaje"]</div>
    }

    @if (TempData["Error"] != null)
    {
        <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded mb-3">@TempData["Error"]</div>
    }

    @if (!Model.Any())
    {
        <div class="bg-blue-100 border border-blue-300 text-blue-800 rounded text-center py-12">
            <i class="bi bi-flower1 text-5xl"></i>
            <h5 class="mt-3 text-lg font-semibold">Tu jardín está vacío</h5>
            <p class="mb-3">Agrega tus primeras plantas desde el catálogo</p>
            <a asp-controller="Plantas" asp-action="Index" class="inline-block px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Explorar Plantas</a>
        </div>
    }
    else
    {
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4" id="listado-plantas">
            @foreach (var planta in Model)
            {
                <div class="sortable-item mb-4" data-id="@planta.MiJardinId">
                    <div class="bg-white border-0 rounded-lg shadow-sm h-full flex flex-col">
                        @if (!string.IsNullOrEmpty(planta.PlantaImagenUrl))
                        {
                            <img src="@planta.PlantaImagenUrl"
                                 class="w-full rounded-t-lg h-44 object-cover"
                                 alt="@planta.PlantaNombre">
                        }
                        else
                        {
                            <div class="bg-gray-100 flex items-center justify-center h-44 rounded-t-lg">
                                <i class="bi bi-flower1 text-gray-400 text-4xl"></i>
                            </div>
                        }

                        <div class="p-4 flex-1">
                            <h5 class="text-lg mb-1 font-semibold">
                                @if (!string.IsNullOrEmpty(planta.Apodo))
                                {
                                    @planta.Apodo <small class="text-gray-500">(@planta.PlantaNombre)</small>
                                }
                                else
                                {
                                    @planta.PlantaNombre
                                }
                            </h5>

                            @if (!string.IsNullOrEmpty(planta.PlantaNombreCientifico))
                            {
                                <p class="text-gray-500 italic text-sm">@planta.PlantaNombreCientifico</p>
                            }

                            <p class="text-sm mb-1"><strong>Ubicación:</strong> @planta.Ubicacion</p>
                            <p class="text-sm mb-2"><strong>Agregada:</strong> @planta.Fecha_Agregada.ToString("dd/MM/yyyy")</p>

                            @if (planta.UltimoRiego.HasValue)
                            {
                                <p class="text-sm mb-2">
                                    <strong>Último riego:</strong> @planta.UltimoRiego.Value.ToString("dd/MM/yyyy")
                                    @if (planta.DiasDesdeUltimoRiego.HasValue)
                                    {
                                        <span class="inline-block px-2 py-1 text-xs rounded @(planta.NecesitaRiego ? "bg-red-500 text-white" : "bg-green-500 text-white")">
                                            Hace @planta.DiasDesdeUltimoRiego días
                                        </span>
                                    }
                                </p>
                            }
                            else
                            {
                                <p class="text-gray-500 text-sm mb-2">Aún no requiere riego</p>
                            }

                            @if (planta.NecesitaRiego)
                            {
                                <p class="text-red-600 text-sm mb-2 font-semibold">¡Necesita riego!</p>
                            }

                            @if (planta.UltimoFertilizado.HasValue)
                            {
                                <p class="text-sm mb-2"><strong>Último fertilizado:</strong> @planta.UltimoFertilizado.Value.ToString("dd/MM/yyyy")</p>
                            }

                            <hr class="my-2 border-gray-200" />

                            <p class="text-sm mb-1"><strong>Riego:</strong> @planta.RiegoNombre</p>

                            @if (planta.Frecuencia_Dias_Verano.HasValue)
                            {
                                <p class="text-sm mb-1">Verano: cada @planta.Frecuencia_Dias_Verano días</p>
                            }

                            @if (planta.Frecuencia_Dias_Invierno.HasValue)
                            {
                                <p class="text-sm mb-1">Invierno: cada @planta.Frecuencia_Dias_Invierno días</p>
                            }

                            @if (!string.IsNullOrEmpty(planta.LuzTipo))
                            {
                                <p class="text-sm mb-0"><strong>Luz:</strong> @planta.LuzTipo</p>
                            }
                        </div>

                        <div class="bg-white border-0 pt-2 pb-3 px-4">
                            <div class="flex justify-between flex-wrap gap-2">
                                @if (planta.NecesitaRiego || !planta.UltimoRiego.HasValue)
                                {
                                    <form asp-action="RegistrarRiego" method="post" class="inline">
                                        <input type="hidden" name="id" value="@planta.MiJardinId" />
                                        <button type="submit" class="px-3 py-1 text-sm bg-blue-600 text-white rounded hover:bg-blue-700">
                                            <i class="bi bi-droplet-fill"></i> Regar
                                        </button>
                                    </form>
                                }

                                <button type="button" class="px-3 py-1 text-sm border border-gray-500 text-gray-700 rounded hover:bg-gray-100"
                                        onclick="openModal('editarModal@(planta.MiJardinId)')">
                                    Editar
                                </button>

                                <a asp-controller="Plantas"
                                   asp-action="DetallePlanta"
                                   asp-route-id="@planta.PlantaId"
                                   class="px-3 py-1 text-sm border border-blue-400 text-blue-600 rounded hover:bg-blue-50">
                                    Detalles
                                </a>

                                <form asp-action="Eliminar" method="post" class="inline"
                                      onsubmit="return confirm('¿Eliminar esta planta de tu jardín?');">
                                    <input type="hidden" name="id" value="@planta.MiJardinId" />
                                    <button type="submit" class="px-3 py-1 text-sm border border-red-600 text-red-600 rounded hover:bg-red-50">
                                        Eliminar
                                    </button>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            }
        </div>

        @foreach (var planta in Model)
        {
            <div class="hidden fixed inset-0 bg-black bg-opacity-50 z-50 flex items-center justify-center" id="editarModal@(planta.MiJardinId)" tabindex="-1">
                <div class="bg-white rounded-lg max-w-md w-full mx-4">
                    <form asp-action="Actualizar" method="post">
                        <div class="p-4 border-b border-gray-200 flex justify-between items-center">
                            <h5 class="text-lg font-bold">Editar @planta.PlantaNombre</h5>
                            <button type="button" class="text-gray-500 hover:text-gray-700" onclick="closeModal('editarModal@(planta.MiJardinId)')">
                                <span class="text-2xl">&times;</span>
                            </button>
                        </div>
                        <div class="p-4">
                            <input type="hidden" name="id" value="@planta.MiJardinId" />
                            <div class="mb-3">
                                <label class="block mb-2 font-medium">Apodo</label>
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" name="apodo" value="@planta.Apodo" />
                            </div>
                            <div class="mb-3">
                                <label class="block mb-2 font-medium">Ubicación</label>
                                <input type="text" class="w-full px-3 py-2 border border-gray-300 rounded focus:outline-none focus:ring-2 focus:ring-blue-500" name="ubicacion" value="@planta.Ubicacion" />
                            </div>
                        </div>
                        <div class="p-4 border-t border-gray-200 flex gap-2 justify-end">
                            <button type="button" class="px-4 py-2 bg-gray-500 text-white rounded hover:bg-gray-600" onclick="closeModal('editarModal@(planta.MiJardinId)')">Cancelar</button>
                            <button type="submit" class="px-4 py-2 bg-blue-600 text-white rounded hover:bg-blue-700">Guardar</button>
                        </div>
                    </form>
                </div>
            </div>
        }
    }
</div>

@section Scripts {
    <script>
        function openModal(modalId) {
            document.getElementById(modalId).classList.remove('hidden');
        }
        
        function closeModal(modalId) {
            document.getElementById(modalId).classList.add('hidden');
        }

        $(function () {
            if (typeof $.fn.sortable === 'undefined') {
                alert('Error: jQuery UI no está cargado.');
                return;
            }

            $("#listado-plantas").sortable({
                update: function () {
                    var ids = [];
                    $("#listado-plantas > div.sortable-item").each(function() {
                        var id = $(this).data("id");
                        if (id !== undefined && id !== null && id > 0) {
                            ids.push(parseInt(id));
                        }
                    });

                    $.ajax({
                        url: '/MiJardin/Ordenar',
                        type: 'POST',
                        contentType: 'application/json',
                        data: JSON.stringify(ids),
                        success: function(response) {
                            console.log('✅ Orden actualizado');
                            var mensaje = $('<div class="fixed top-4 right-4 bg-green-500 text-white px-6 py-3 rounded shadow-lg z-50">Orden guardado ✓</div>');
                            $('body').append(mensaje);
                            setTimeout(function() {
                                mensaje.fadeOut(function() {
                                    $(this).remove();
                                });
                            }, 2000);
                        },
                        error: function(xhr) {
                            console.error('❌ Error:', xhr);
                            $("#listado-plantas").sortable("cancel");
                        }
                    });
                },
                placeholder: "sortable-placeholder",
                opacity: 0.8,
                tolerance: "pointer"
            });

            $("#listado-plantas").on("mousedown", "button, a, input, form", function (e) {
                e.stopPropagation();
            });
        });
    </script>
}